"""–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–æ–≤–∞—Ä–∞–º–∏."""

from __future__ import annotations

from typing import List, Optional, Dict
import json
import logging
from langchain_core.tools import tool

from src.config.constants import VECTOR_SEARCH_LIMIT
from src.utils.retrievers import SupabaseVectorRetriever
from src.database.queries.products_queries import get_random_products as get_random_products_db
from src.utils.prompts import get_all_system_values

logger = logging.getLogger(__name__)


@tool
async def vector_search(query: str) -> str:
    """–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ (embeddings) –¥–ª—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ —Å–º—ã—Å–ª—É –∑–∞–ø—Ä–æ—Å–∞.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–æ 50 —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ —Å ID –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ.

    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    –ö–û–ì–î–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨:
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π –¥–ª—è:
    - –¢–µ–∫—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –æ —Ç–æ–≤–∞—Ä–∞—Ö: "–ß—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å?", "–ü–æ–∫–∞–∂–∏ –º—è—Å–æ", "–ö–∞–∫–∏–µ —Å—Ç–µ–π–∫–∏?"
    - –ü–æ–∏—Å–∫ –ø–æ —Ç–∏–ø—É/—á–∞—Å—Ç–∏: "–≥—Ä—É–¥–∏–Ω–∫–∞ —Å–≤–∏–Ω–∞—è", "–≥–æ–≤—è–¥–∏–Ω–∞", "—Å—Ç–µ–π–∫–∏", "–ø–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç—ã"
    - –ü–æ–∏—Å–∫ –ø–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫—É: "—Ç–æ–≤–∞—Ä—ã –æ—Ç –ö–æ—Ä–∞–ª–ª", "–ø—Ä–æ–¥—É–∫—Ü–∏—è –ú–∏—Ä–æ—Ç–æ—Ä–≥", "—á—Ç–æ –µ—Å—Ç—å –æ—Ç X"
    - –ü–æ–∏—Å–∫ –ø–æ —Ä–µ–≥–∏–æ–Ω—É: "–º—è—Å–æ –∏–∑ –°–∏–±–∏—Ä–∏", "—Ç–æ–≤–∞—Ä—ã –∏–∑ –ë—É—Ä—è—Ç–∏–∏", "—Ä–µ–≥–∏–æ–Ω –ê–ª—Ç–∞–π"
    - –ö–æ–º–±–∏–Ω–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤: "—Å–≤–∏–Ω–∏–Ω–∞ –æ—Ö–ª–∞–∂–¥–µ–Ω–Ω–∞—è", "—Å—Ç–µ–π–∫–∏ –æ—Ç –ö–æ—Ä–∞–ª–ª"
    - –ó–∞–ø—Ä–æ—Å—ã –ë–ï–ó —á–∏—Å–ª–æ–≤—ã—Ö —É—Å–ª–æ–≤–∏–π (—Ü–µ–Ω–∞, –≤–µ—Å, —Å–∫–∏–¥–∫–∞ —Å —á–∏—Å–ª–∞–º–∏)

    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    –û—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç:
    - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
    - –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (–∫–∞–∂–¥—ã–π —Ç–æ–≤–∞—Ä –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏)
    - –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å –µ—â—ë —Ç–æ–≤–∞—Ä—ã (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 50)
    - –°–µ–∫—Ü–∏—é [PRODUCT_IDS] —Å ID —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ

    Args:
        query: –¢–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ —Ç–æ–≤–∞—Ä–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–≥—Ä—É–¥–∏–Ω–∫–∞ —Å–≤–∏–Ω–∞—è", "—Ç–æ–≤–∞—Ä—ã –æ—Ç –ö–æ—Ä–∞–ª–ª")

    Returns:
        –°—Ç—Ä–æ–∫–∞ —Å –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Å–ø–∏—Å–∫–æ–º –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ (–¥–æ 50) –∏ –∏—Ö ID –≤ —Å–µ–∫—Ü–∏–∏ [PRODUCT_IDS]
    """
    retriever = SupabaseVectorRetriever()

    try:
        documents = await retriever.get_relevant_documents(query, k=VECTOR_SEARCH_LIMIT + 1)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø–æ –∑–∞–ø—Ä–æ—Å—É '{query}': {e}", exc_info=True)
        return "–¢–æ–≤–∞—Ä—ã –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."

    if not documents:
        return "–¢–æ–≤–∞—Ä—ã –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."

    has_more = len(documents) > VECTOR_SEARCH_LIMIT

    documents = documents[:VECTOR_SEARCH_LIMIT]

    products_list = []
    product_ids = []
    for doc in documents:
        metadata = doc.metadata
        product_id = metadata.get('id')
        if product_id:
            product_ids.append(product_id)

        title = metadata.get('title', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')
        supplier = metadata.get('supplier_name', '')
        price = metadata.get('order_price_kg', '')
        region = metadata.get('from_region', '')
        
        product_lines = [f"üì¶ {title}"]
        if supplier and supplier != '–ù–µ —É–∫–∞–∑–∞–Ω–æ':
            product_lines.append(f"   –ü–æ—Å—Ç–∞–≤—â–∏–∫: {supplier}")
        if price and price != '–ù–µ —É–∫–∞–∑–∞–Ω–æ':
            product_lines.append(f"   –¶–µ–Ω–∞: {price}‚ÇΩ/–∫–≥")
        if region and region != '–ù–µ —É–∫–∞–∑–∞–Ω–æ':
            product_lines.append(f"   –†–µ–≥–∏–æ–Ω: {region}")
        
        products_list.append("\n".join(product_lines))

    result = "\n\n".join(products_list)
    more_text = "\n\n‚ö†Ô∏è –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å –µ—â—ë —Ç–æ–≤–∞—Ä—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 50. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è." if has_more else ""

    ids_json = json.dumps({"product_ids": product_ids}) if product_ids else ""
    ids_section = f"\n\n[PRODUCT_IDS]{ids_json}[/PRODUCT_IDS]" if ids_json else ""

    return f"–ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: {len(documents)}{more_text}\n\n{result}{ids_section}"


@tool
async def get_random_products(limit: int = 10) -> str:
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞ (FALLBACK –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç).

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –ø–æ—Å–ª–µ–¥–Ω—è—è –Ω–∞–¥–µ–∂–¥–∞, –∫–æ–≥–¥–∞ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ø–æ–∏—Å–∫–∞ –Ω–µ –¥–∞–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞.

    –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞:
    - vector_search –≤–µ—Ä–Ω—É–ª "–¢–æ–≤–∞—Ä—ã –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    - execute_sql_request –≤–µ—Ä–Ω—É–ª "–¢–æ–≤–∞—Ä—ã –ø–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    - –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ø–æ–∏—Å–∫–∞ –Ω–µ –¥–∞–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    - –ù—É–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞ –∫–æ–≥–¥–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ

    Args:
        limit: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10, –º–∞–∫—Å–∏–º—É–º 20)

    Returns:
        –°—Ç—Ä–æ–∫–∞ —Å –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Å–ø–∏—Å–∫–æ–º —Å–ª—É—á–∞–π–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∏ –∏—Ö ID –≤ —Å–µ–∫—Ü–∏–∏ [PRODUCT_IDS]
    """
    if limit > 20:
        limit = 20

    try:
        json_result = await get_random_products_db(limit)

        if not json_result:
            return "–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."

        products_list = []
        product_ids = []
        for product in json_result:
            product_id = product.get('id')
            if product_id:
                product_ids.append(product_id)

            product_info = [
                f"–ù–∞–∑–≤–∞–Ω–∏–µ: {product.get('title', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}",
                f"–ü–æ—Å—Ç–∞–≤—â–∏–∫: {product.get('supplier_name', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}",
                f"–†–µ–≥–∏–æ–Ω: {product.get('from_region', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}",
                f"–¶–µ–Ω–∞ –∑–∞ –∫–≥: {product.get('order_price_kg', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}",
                f"–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑ (–∫–≥): {product.get('min_order_weight_kg', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}",
            ]
            products_list.append(
                "\n".join([info for info in product_info if "–ù–µ —É–∫–∞–∑–∞–Ω–æ" not in info])
            )

        result_text = "\n\n---\n\n".join(products_list)

        ids_json = json.dumps({"product_ids": product_ids}) if product_ids else ""
        ids_section = f"\n\n[PRODUCT_IDS]{ids_json}[/PRODUCT_IDS]" if ids_json else ""

        return f"–ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: {len(json_result)}\n\n{result_text}{ids_section}"

    except RuntimeError as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö: {e}")
        return "–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö."
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ª—É—á–∞–π–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤: {e}")
        return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤: {str(e)}"
